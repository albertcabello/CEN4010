{"ast":null,"code":"var Sequence = require('./Sequence');\n\nvar Util = require('util');\n\nvar Packets = require('../packets');\n\nvar Auth = require('../Auth');\n\nvar ClientConstants = require('../constants/client');\n\nmodule.exports = Handshake;\nUtil.inherits(Handshake, Sequence);\n\nfunction Handshake(options, callback) {\n  Sequence.call(this, options, callback);\n  options = options || {};\n  this._config = options.config;\n  this._handshakeInitializationPacket = null;\n}\n\nHandshake.prototype.determinePacket = function determinePacket(firstByte, parser) {\n  if (firstByte === 0xff) {\n    return Packets.ErrorPacket;\n  }\n\n  if (!this._handshakeInitializationPacket) {\n    return Packets.HandshakeInitializationPacket;\n  }\n\n  if (firstByte === 0xfe) {\n    return parser.packetLength() === 1 ? Packets.UseOldPasswordPacket : Packets.AuthSwitchRequestPacket;\n  }\n\n  return undefined;\n};\n\nHandshake.prototype['AuthSwitchRequestPacket'] = function (packet) {\n  if (packet.authMethodName === 'mysql_native_password') {\n    var challenge = packet.authMethodData.slice(0, 20);\n    this.emit('packet', new Packets.AuthSwitchResponsePacket({\n      data: Auth.token(this._config.password, challenge)\n    }));\n  } else {\n    var err = new Error('MySQL is requesting the ' + packet.authMethodName + ' authentication method, which is not supported.');\n    err.code = 'UNSUPPORTED_AUTH_METHOD';\n    err.fatal = true;\n    this.end(err);\n  }\n};\n\nHandshake.prototype['HandshakeInitializationPacket'] = function (packet) {\n  this._handshakeInitializationPacket = packet;\n  this._config.protocol41 = packet.protocol41;\n  var serverSSLSupport = packet.serverCapabilities1 & ClientConstants.CLIENT_SSL;\n\n  if (this._config.ssl) {\n    if (!serverSSLSupport) {\n      var err = new Error('Server does not support secure connection');\n      err.code = 'HANDSHAKE_NO_SSL_SUPPORT';\n      err.fatal = true;\n      this.end(err);\n      return;\n    }\n\n    this._config.clientFlags |= ClientConstants.CLIENT_SSL;\n    this.emit('packet', new Packets.SSLRequestPacket({\n      clientFlags: this._config.clientFlags,\n      maxPacketSize: this._config.maxPacketSize,\n      charsetNumber: this._config.charsetNumber\n    }));\n    this.emit('start-tls');\n  } else {\n    this._sendCredentials();\n  }\n};\n\nHandshake.prototype._tlsUpgradeCompleteHandler = function () {\n  this._sendCredentials();\n};\n\nHandshake.prototype._sendCredentials = function () {\n  var packet = this._handshakeInitializationPacket;\n  this.emit('packet', new Packets.ClientAuthenticationPacket({\n    clientFlags: this._config.clientFlags,\n    maxPacketSize: this._config.maxPacketSize,\n    charsetNumber: this._config.charsetNumber,\n    user: this._config.user,\n    database: this._config.database,\n    protocol41: packet.protocol41,\n    scrambleBuff: packet.protocol41 ? Auth.token(this._config.password, packet.scrambleBuff()) : Auth.scramble323(packet.scrambleBuff(), this._config.password)\n  }));\n};\n\nHandshake.prototype['UseOldPasswordPacket'] = function () {\n  if (!this._config.insecureAuth) {\n    var err = new Error('MySQL server is requesting the old and insecure pre-4.1 auth mechanism. ' + 'Upgrade the user password or use the {insecureAuth: true} option.');\n    err.code = 'HANDSHAKE_INSECURE_AUTH';\n    err.fatal = true;\n    this.end(err);\n    return;\n  }\n\n  this.emit('packet', new Packets.OldPasswordPacket({\n    scrambleBuff: Auth.scramble323(this._handshakeInitializationPacket.scrambleBuff(), this._config.password)\n  }));\n};\n\nHandshake.prototype['ErrorPacket'] = function (packet) {\n  var err = this._packetToError(packet, true);\n\n  err.fatal = true;\n  this.end(err);\n};","map":null,"metadata":{},"sourceType":"script"}